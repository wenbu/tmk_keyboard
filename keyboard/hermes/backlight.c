#include <avr/io.h>
#include <avr/interrupt.h>
#include "backlight.h"
#include "print.h"
#include "i2c_soft.h"

void i2c_send_page(uint8_t*, uint8_t, uint8_t);

// addr: 0b11101000 (write)
//         11101001 (read)
//       0x   e   8
//       0x   e   9

#define DEVICE_ADDRESS_WRITE 0xe8
#define DEVICE_ADDRESS_READ 0xe9

#define ADDRESS_COMMAND_REGISTER 0xFD
#define ADDRESS_PAGE_ONE 0x00
#define ADDRESS_PAGE_NINE 0x0b

#define ADDRESS_LED_CONTROL_REGISTER 0x00
#define ADDRESS_LED_PWM_REGISTER 0x24
const uint8_t selectPageOne[] = {
    DEVICE_ADDRESS_WRITE,
    ADDRESS_COMMAND_REGISTER,
    ADDRESS_PAGE_ONE
};

const uint8_t ledEnableMask[] = {
    DEVICE_ADDRESS_WRITE,
    ADDRESS_LED_CONTROL_REGISTER,
    0xFE, 0x00, // C1-1 : C1-16
    0xFE, 0x00, // C2-1 : C2-16
    0xFE, 0x00, // C3-1 : C3-16
    0x00, 0x00, // C4-1 : C4-16
    0x00, 0x00, // C5-1 : C5-16
    0x00, 0x00, // C6-1 : C6-16
    0x00, 0x00, // C7-1 : C7-16
    0x00, 0x00, // C8-1 : C8-16
    0x00, 0x00  // C9-1 : C9-16
};

const uint8_t allWhite[] = {
    DEVICE_ADDRESS_WRITE,
    ADDRESS_LED_PWM_REGISTER,
    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

void backlight_init() {
    print("backlight_init()\n");

    // initialize I2C
    i2c_init();

    // send inital config (LED activation, initial color)
    i2c_send_page(ledEnableMask, sizeof(ledEnableMask), 0);
    i2c_send_page(allWhite, sizeof(allWhite), 0);
}

void i2c_send_page(uint8_t* data, uint8_t len, uint8_t page) {
    uint8_t pageSelect[] = { DEVICE_ADDRESS_WRITE, ADDRESS_COMMAND_REGISTER, page };

    i2c_send_data(pageSelect, 3);
    i2c_send_data(data, len); 
}

void backlight_set(color_t level) {
    // TODO
}

void backlight_enable() {
}

void backlight_disable() {
}

void backlight_brighten() {
}

void backlight_dim() {
}
